#include <stdlib.h>
#include <string.h>

#include "pico/stdlib.h"
#include "hardware/i2c.h"

#define I2C_DISPLAY_LINE    i2c1 
#define I2C_DISPLAY_SDA     26
#define I2C_DISPLAY_SCL     27

#define MODE_ADDR       0b00000000
#define BRIGHTNESS_ADDR 0b00011001
#define UPDATE_ADDR     0b00001100
#define OPTION_ADDR     0b00001101
#define MATRIX_A_ADDR   0b00001110
#define MATRIX_B_ADDR   0b00000001

#define DEFAULT_MODE    0b00011000
#define DEFAULT_OPTIONS 0b00001110

uint8_t addresses[8] = { 0x63, 0x63, 0x60, 0x60, 0x62, 0x62, 0x61, 0x61 };
uint8_t displays[8][8] = { 
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 }
};

uint8_t characters[][8] = {
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } ,  // (space)
    { 0x00, 0x00, 0x5f, 0x00, 0x00, 0x00, 0x00, 0x00 } ,  // !
    { 0x00, 0x07, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00 } ,  // "
    { 0x14, 0x7f, 0x14, 0x7f, 0x14, 0x00, 0x00, 0x00 } ,  // #
    { 0x24, 0x2a, 0x7f, 0x2a, 0x12, 0x00, 0x00, 0x00 } ,  // $
    { 0x23, 0x13, 0x08, 0x64, 0x62, 0x00, 0x00, 0x00 } ,  // %
    { 0x36, 0x49, 0x55, 0x22, 0x50, 0x00, 0x00, 0x00 } ,  // &
    { 0x00, 0x05, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00 } ,  // '
    { 0x00, 0x1c, 0x22, 0x41, 0x00, 0x00, 0x00, 0x00 } ,  // (
    { 0x00, 0x41, 0x22, 0x1c, 0x00, 0x00, 0x00, 0x00 } ,  // )
    { 0x08, 0x2a, 0x1c, 0x2a, 0x08, 0x00, 0x00, 0x00 } ,  // *
    { 0x08, 0x08, 0x3e, 0x08, 0x08, 0x00, 0x00, 0x00 } ,  // +
    { 0x00, 0x50, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00 } ,  // ,
    { 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00 } ,  // -
    { 0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00 } ,  // .
    { 0x20, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00, 0x00 } ,  // /
    { 0x3e, 0x51, 0x49, 0x45, 0x3e, 0x00, 0x00, 0x00 } ,  // 0
    { 0x00, 0x42, 0x7f, 0x40, 0x00, 0x00, 0x00, 0x00 } ,  // 1
    { 0x42, 0x61, 0x51, 0x49, 0x46, 0x00, 0x00, 0x00 } ,  // 2
    { 0x21, 0x41, 0x45, 0x4b, 0x31, 0x00, 0x00, 0x00 } ,  // 3
    { 0x18, 0x14, 0x12, 0x7f, 0x10, 0x00, 0x00, 0x00 } ,  // 4
    { 0x27, 0x45, 0x45, 0x45, 0x39, 0x00, 0x00, 0x00 } ,  // 5
    { 0x3c, 0x4a, 0x49, 0x49, 0x30, 0x00, 0x00, 0x00 } ,  // 6
    { 0x01, 0x71, 0x09, 0x05, 0x03, 0x00, 0x00, 0x00 } ,  // 7
    { 0x36, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00, 0x00 } ,  // 8
    { 0x06, 0x49, 0x49, 0x29, 0x1e, 0x00, 0x00, 0x00 } ,  // 9
    { 0x00, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00 } ,  // :
    { 0x00, 0x56, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00 } ,  // ;
    { 0x00, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x00 } ,  // <
    { 0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x00, 0x00 } ,  // =
    { 0x41, 0x22, 0x14, 0x08, 0x00, 0x00, 0x00, 0x00 } ,  // >
    { 0x02, 0x01, 0x51, 0x09, 0x06, 0x00, 0x00, 0x00 } ,  // ?
    { 0x32, 0x49, 0x79, 0x41, 0x3e, 0x00, 0x00, 0x00 } ,  // @
    { 0x7e, 0x11, 0x11, 0x11, 0x7e, 0x00, 0x00, 0x00 } ,  // A
    { 0x7f, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00, 0x00 } ,  // B
    { 0x3e, 0x41, 0x41, 0x41, 0x22, 0x00, 0x00, 0x00 } ,  // C
    { 0x7f, 0x41, 0x41, 0x22, 0x1c, 0x00, 0x00, 0x00 } ,  // D
    { 0x7f, 0x49, 0x49, 0x49, 0x41, 0x00, 0x00, 0x00 } ,  // E
    { 0x7f, 0x09, 0x09, 0x01, 0x01, 0x00, 0x00, 0x00 } ,  // F
    { 0x3e, 0x41, 0x41, 0x51, 0x32, 0x00, 0x00, 0x00 } ,  // G
    { 0x7f, 0x08, 0x08, 0x08, 0x7f, 0x00, 0x00, 0x00 } ,  // H
    { 0x00, 0x41, 0x7f, 0x41, 0x00, 0x00, 0x00, 0x00 } ,  // I
    { 0x20, 0x40, 0x41, 0x3f, 0x01, 0x00, 0x00, 0x00 } ,  // J
    { 0x7f, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x00 } ,  // K
    { 0x7f, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00 } ,  // L
    { 0x7f, 0x02, 0x04, 0x02, 0x7f, 0x00, 0x00, 0x00 } ,  // M
    { 0x7f, 0x04, 0x08, 0x10, 0x7f, 0x00, 0x00, 0x00 } ,  // N
    { 0x3e, 0x41, 0x41, 0x41, 0x3e, 0x00, 0x00, 0x00 } ,  // O
    { 0x7f, 0x09, 0x09, 0x09, 0x06, 0x00, 0x00, 0x00 } ,  // P
    { 0x3e, 0x41, 0x51, 0x21, 0x5e, 0x00, 0x00, 0x00 } ,  // Q
    { 0x7f, 0x09, 0x19, 0x29, 0x46, 0x00, 0x00, 0x00 } ,  // R
    { 0x46, 0x49, 0x49, 0x49, 0x31, 0x00, 0x00, 0x00 } ,  // S
    { 0x01, 0x01, 0x7f, 0x01, 0x01, 0x00, 0x00, 0x00 } ,  // T
    { 0x3f, 0x40, 0x40, 0x40, 0x3f, 0x00, 0x00, 0x00 } ,  // U
    { 0x1f, 0x20, 0x40, 0x20, 0x1f, 0x00, 0x00, 0x00 } ,  // V
    { 0x7f, 0x20, 0x18, 0x20, 0x7f, 0x00, 0x00, 0x00 } ,  // W
    { 0x63, 0x14, 0x08, 0x14, 0x63, 0x00, 0x00, 0x00 } ,  // X
    { 0x03, 0x04, 0x78, 0x04, 0x03, 0x00, 0x00, 0x00 } ,  // Y
    { 0x61, 0x51, 0x49, 0x45, 0x43, 0x00, 0x00, 0x00 } ,  // Z
    { 0x00, 0x00, 0x7f, 0x41, 0x41, 0x00, 0x00, 0x00 } ,  // [
    { 0x02, 0x04, 0x08, 0x10, 0x20, 0x00, 0x00, 0x00 } ,  // 
    { 0x41, 0x41, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00 } ,  // ]
    { 0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00 } ,  // ^
    { 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00 } ,  // _
    { 0x00, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00 } ,  // `
    { 0x20, 0x54, 0x54, 0x54, 0x78, 0x00, 0x00, 0x00 } ,  // a
    { 0x7f, 0x48, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00 } ,  // b
    { 0x38, 0x44, 0x44, 0x44, 0x20, 0x00, 0x00, 0x00 } ,  // c
    { 0x38, 0x44, 0x44, 0x48, 0x7f, 0x00, 0x00, 0x00 } ,  // d
    { 0x38, 0x54, 0x54, 0x54, 0x18, 0x00, 0x00, 0x00 } ,  // e
    { 0x08, 0x7e, 0x09, 0x01, 0x02, 0x00, 0x00, 0x00 } ,  // f
    { 0x08, 0x14, 0x54, 0x54, 0x3c, 0x00, 0x00, 0x00 } ,  // g
    { 0x7f, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00, 0x00 } ,  // h
    { 0x00, 0x44, 0x7d, 0x40, 0x00, 0x00, 0x00, 0x00 } ,  // i
    { 0x20, 0x40, 0x44, 0x3d, 0x00, 0x00, 0x00, 0x00 } ,  // j
    { 0x00, 0x7f, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00 } ,  // k
    { 0x00, 0x41, 0x7f, 0x40, 0x00, 0x00, 0x00, 0x00 } ,  // l
    { 0x7c, 0x04, 0x18, 0x04, 0x78, 0x00, 0x00, 0x00 } ,  // m
    { 0x7c, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00, 0x00 } ,  // n
    { 0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00 } ,  // o
    { 0x7c, 0x14, 0x14, 0x14, 0x08, 0x00, 0x00, 0x00 } ,  // p
    { 0x08, 0x14, 0x14, 0x18, 0x7c, 0x00, 0x00, 0x00 } ,  // q
    { 0x7c, 0x08, 0x04, 0x04, 0x08, 0x00, 0x00, 0x00 } ,  // r
    { 0x48, 0x54, 0x54, 0x54, 0x20, 0x00, 0x00, 0x00 } ,  // s
    { 0x04, 0x3f, 0x44, 0x40, 0x20, 0x00, 0x00, 0x00 } ,  // t
    { 0x3c, 0x40, 0x40, 0x20, 0x7c, 0x00, 0x00, 0x00 } ,  // u
    { 0x1c, 0x20, 0x40, 0x20, 0x1c, 0x00, 0x00, 0x00 } ,  // v
    { 0x3c, 0x40, 0x30, 0x40, 0x3c, 0x00, 0x00, 0x00 } ,  // w
    { 0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00 } ,  // x
    { 0x0c, 0x50, 0x50, 0x50, 0x3c, 0x00, 0x00, 0x00 } ,  // y
    { 0x44, 0x64, 0x54, 0x4c, 0x44, 0x00, 0x00, 0x00 } ,  // z
    { 0x00, 0x08, 0x36, 0x41, 0x00, 0x00, 0x00, 0x00 } ,  // {
    { 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00 } ,  // |
    { 0x00, 0x41, 0x36, 0x08, 0x00, 0x00, 0x00, 0x00 } ,  // }
    { 0x08, 0x08, 0x2a, 0x1c, 0x08, 0x00, 0x00, 0x00 } ,  // ~
};

uint8_t alternate_characters[count_of(characters)][8];

char *append_chars(const char *original, char character_to_append, size_t num_chars) {
    size_t original_length = strlen(original);
    char *new_string = (char *)malloc(original_length + num_chars + 1); // +1 for the null terminator

    if (new_string == NULL) {
        return NULL; // Memory allocation failed
    }

    strcpy(new_string, original);
    
    for (size_t i = 0; i < num_chars; i++) {
        new_string[original_length + i] = character_to_append;
    }
    
    new_string[original_length + num_chars] = '\0'; // Null-terminate the string

    return new_string;
}


void convertLeftToRight(const uint8_t *left_matrix, uint8_t *right_matrix) {
    for (int row = 0; row < 8; row++) {
        for (int col = 0; col < 8; col++) {
            uint8_t bit_value = (left_matrix[row] >> (col)) & 1;
            right_matrix[col] |= (bit_value << row);
        }
    }
}

void pre_generate_alternate_characters() {
    for (int i = 0; i < count_of(characters); i++)
    {
        convertLeftToRight(characters[i], alternate_characters[i]);
    }   
}

void set_option(int display, uint8_t address, uint8_t value) {
    if (display < 0 || display > 7) return;

    uint8_t buf[2];

    buf[0] = address;
    buf[1] = value;

    i2c_write_blocking(I2C_DISPLAY_LINE, addresses[display], buf, count_of(buf), false);
}

uint8_t* prepend_address(uint8_t address, uint8_t buffer[], int buffer_size) {
    int new_buffer_size = buffer_size + 1;
    
    uint8_t* new_buffer = (uint8_t*)malloc(new_buffer_size * sizeof(uint8_t));

    if (new_buffer == NULL) {
        return NULL; 
    }
    
    new_buffer[0] = address;
    
    for (int i = 0; i < buffer_size; i++) {
        new_buffer[i + 1] = buffer[i];
    }
    
    return new_buffer;
}

void update_display() {
    for (int i = 0; i < count_of(displays); i++)
    {
        if (i % 2 == 0) {
            uint8_t* pre_mat_a_buf = prepend_address(MATRIX_A_ADDR, displays[i], count_of(displays[i]));
            i2c_write_blocking(I2C_DISPLAY_LINE, addresses[i], pre_mat_a_buf, count_of(displays[i]) + 1, false);
            free(pre_mat_a_buf);

        } else {
            uint8_t* pre_mat_b_buf = prepend_address(MATRIX_B_ADDR, displays[i], count_of(displays[i]));
            i2c_write_blocking(I2C_DISPLAY_LINE, addresses[i], pre_mat_b_buf, count_of(displays[i]) + 1, false);
            free(pre_mat_b_buf);


            set_option(i, MODE_ADDR, DEFAULT_MODE);
            set_option(i, OPTION_ADDR, DEFAULT_OPTIONS);
            set_option(i, BRIGHTNESS_ADDR, 0b00011111);
            set_option(i, UPDATE_ADDR, 0b00000001);
        }    
    }
}

// Set a pixel on a display zero base indexed
void set_pixel(int display, uint8_t x, uint8_t y, bool status, bool update) {
    if (display < 0 || display > 7) return;

    if (display % 2 == 0) {
        uint8_t tempX = x;
        x = y;
        y = tempX; 
    }
    
    uint8_t changeVal = 1;
    changeVal <<= x;
    
    if (status) {    
        displays[display][y] |= changeVal;
    } else {
        uint8_t value = displays[display][y];
        value = ~value;
        value |= changeVal;
        value = ~value;
        displays[display][y] = value;
    }

    if (update) update_display();
}


void set_brightness(double value) {

}

void clear_all(bool update) {
    for (int i = 0; i < count_of(displays); i++)
    {
        for (int j = 0; j < 8; j++)
        {
            displays[i][j] = 0;
        }
    
    }

    if (update) update_display();
}

void clear(int display, bool update) {
    if (display < 0 || display > 7) return;
    for (int i = 0; i < 8; i++)
    {
        displays[display][i] = 0;
    }
    

    if (update) update_display();
}

void set_char(int display, char letter, bool update) {
    if (display < 0 || display > 7) return;

    if (display % 2 == 0) {
        for (int i = 0; i < 8; i++)
        {
            displays[display][i] = characters[((int)letter) - 32][i];
        }   
    } else {
        for (int i = 0; i < 8; i++)
        {
            displays[display][i] = alternate_characters[((int)letter) - 32][i];
        }   
    }

    if (update) update_display();
}

void scroll_display_string(char *string) {
    string = append_chars(string, ' ', 8);
    int string_length = strlen(string);

    clear_all(false);

    if (string_length > 8) {
        for (int i = 0; i <= string_length - 8; i++) {
            for (int display = 0; display < 8; display++) {
                char char_to_display = string[i + display];
                set_char(display, char_to_display, false);
            }

            update_display();

            if (i == 0) sleep_ms(750);
            sleep_ms(250); 
        }
        
        sleep_ms(2000);
    } else {
        for (int display = 0; display < string_length; display++) {
            set_char(display, string[display], false);
        }
        update_display();
        sleep_ms(2000); 
    }

    free(string);
    clear_all(true);
}

void display_string(char *string) {
    clear_all(false);

    for (int i = 0; i < strlen(string); i++)
    {
        set_char(i, string[i], false);
    }

    update_display();
}